<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Dinner Menu Builder</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: #dcd3df  ;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .course-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .course-title {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .course-description {
            font-family: 'Georgia', serif;
            font-size: 1.1em;
            line-height: 1.6;
            color: #555;
            margin-bottom: 20px;
            padding: 0 10px;
            font-style: italic;
            letter-spacing: 0.3px;
        }

        .menu-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .menu-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            transition: transform 0.2s;
            position: relative;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .menu-item.selected {
            border: 2px solid #27ae60;
            background-color: #f1f8e9;
        }

        /* Add error state for menu item */
        .menu-item.error {
            background-color: #ffdddd; /* Light red background */
        }

        .menu-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Ribbon styles */
        .ribbon {
            position: absolute;
            top: 10px;
            left: -10px;
            background-color: #67635f; /* Example color */
            color: white;
            padding: 3px 15px;
            font-size: 0.8em;
            border-radius: 0 5px 5px 0;
            z-index: 1;
        }

        .menu-item img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 5px;
            position: relative;
        }

        .menu-item input[type="checkbox"] {
            position: absolute;
            bottom: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 1;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 3px;
        }

        .menu-item.disabled input[type="checkbox"] {
            cursor: not-allowed;
        }

        .menu-item h3 {
            margin-bottom: 3px;
            color: #2c3e50;
            font-size: 1em;
        }

        .menu-item p {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 45px;
            line-height: 1.3;
            max-height: 3.9em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .price-upgrade {
            color: #e74c3c;
            font-weight: bold;
            margin-top: 0px;
            font-size: 0.85em;
        }

        .summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #selected-items {
            margin-top: 15px;
        }

        #selected-items p {
            margin: 5px 0;
        }

        #selected-items strong {
            color: #2c3e50;
        }

        .total-price {
            font-size: 1.2em;
            font-weight: bold;
            color: #27ae60;
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #666;
        }

        .error {
            color: #e74c3c;
            /* text-align: center;
            padding: 20px; */
        }

        .booking-form {
            background-color: #f4eff6;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: bold;
        }

        /* Add styles for required field asterisk */
        .required-field::after {
            content: " *";
            color: #e74c3c;
            font-weight: bold;
        }

        /* New styles for the first two form groups */
        .form-group:nth-child(1) input, /* Your name */
        .form-group:nth-child(2) input, /* Booking date */
        .form-group select { /* Number of Adults and Kids */
            width: 300px; /* Fixed width for these inputs */
            max-width: 100%; /* Ensures mobile responsiveness */
        }

        .form-group input,
        .form-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            background-color: white;
        }

        .form-group select {
            cursor: pointer;
        }

        .form-group select:focus {
            border-color: #3498db;
            outline: none;
        }

        /* Remove the form-row styles since we're not using them anymore */
        .form-row {
            display: block;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: block;
        }

        input:invalid {
            border-color: #e74c3c;
        }

        /* Style for required input fields when blank */
        input:required:invalid {
        background-color: #ffffcc; /* Light yellow */
        } 

        /* Style for required input fields when blank */
        select:required:invalid {
        background-color: #ffffcc; /* Light yellow */
        } 

        input[type="date"] {
            font-family: inherit;
        }

        /* Media query for mobile responsiveness */
        @media (max-width: 600px) {
            .form-group:nth-child(1) input,
            .form-group:nth-child(2) input,
            .form-group select {
                width: 100%; /* Full width on mobile */
            }
        }

        /* Add these new styles */
        .course-count-group {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .course-count-group select {
            width: 330px;
            max-width: 100%;
        }

        .helper-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .price-summary {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .base-price, .upgrade-price {
            color: #666;
            margin-bottom: 5px;
        }

        .total-price {
            font-size: 1.2em;
            font-weight: bold;
            color: #27ae60;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }

        .selection-count.partial-success {
            color: #27ae60;
        }

        .selection-count.error {
            color: #e74c3c;
        }

        .selection-count.success {
            color: #27ae60;
            font-weight: bold;
        }

        /* Remove the "(Required)" text */
        .selection-count::after {
            content: '';
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            overflow: auto;
        }

        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90vh;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #bbb;
        }

        /* Add styles for serving style selection */
        .serving-style-selection {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            display: flex;
            gap: 10px;
        }

        .radio-label {
            flex: 1;
            position: relative;
            cursor: pointer;
            padding: 10px 15px;
            background-color: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .radio-label input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .radio-label:hover {
            border-color: #3498db;
            color: #3498db;
        }

        .radio-label input[type="radio"]:checked + span {
            color: #2c3e50;
        }

        .radio-label input[type="radio"]:checked + span::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -15px;
            right: -15px;
            bottom: -10px;
            background-color: #e3f2fd;
            border-radius: 6px;
            z-index: -1;
        }

        .radio-label span {
            position: relative;
            z-index: 1;
            font-weight: 500;
        }

        /* New styles for the selected state */
        .radio-label.selected {
            background-color: #e3f2fd;
            border-color: #3498db;
        }

        /* Add styles for the send email button */
        .send-email-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .send-email-btn:hover {
            background-color: #2980b9;
        }

        .send-email-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        /* Add styles for the button group */
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .send-email-btn, .whatsapp-btn {
            display: inline-block;
            width: 100%;
            max-width: 200px;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .send-email-btn {
            background-color: #3498db;
            color: white;
            display: none;
        }

        .send-email-btn:hover {
            background-color: #2980b9;
        }

        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            /* display: none; Hide by default */
        }

        .whatsapp-btn:hover {
            background-color: #128C7E;
        }

        .send-email-btn:disabled, .whatsapp-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        /* Show WhatsApp button only on mobile devices */
        @media (max-width: 768px) {
            .whatsapp-btn {
                display: inline-block;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
            }

            .send-email-btn, .whatsapp-btn {
                max-width: 100%;
            }
        }

        /* Development Only - Start */
        .dev-tools {
            border: 1px dashed #ccc;
            display: none;
        }

        .test-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            display: none;
        }

        .test-btn:hover {
            background-color: #5a6268;
        }
        /* Development Only - End */
    </style>
    <!-- Add Papa Parse library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Add EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
    <!-- Add modal HTML -->
    <div id="imageModal" class="modal">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <div class="container">
        <div style="text-align: center; margin-bottom: 10px;">
            <img src="images/gratinee-logo-sm.jpg" alt="Logo" style="max-width: 200px; height: auto;">
        </div>

        <!-- Development Only - Start -->
        <div class="dev-tools" style="margin-bottom: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
            <button id="test-data" class="test-btn">Populate Test Data</button>
            <div class="button-group" style="margin-top: 10px;">
                <button id="send-email-top" class="send-email-btn">Send Menu Selection (Top)</button>
                <button id="send-whatsapp-top" class="whatsapp-btn">Send via WhatsApp (Top)</button>
            </div>
        </div>
        <!-- Development Only - End -->

        <!-- Move the booking form here, right after the title -->
        <div class="booking-form">
            <!-- Development Only - Start -->
            <div class="dev-tools" style="margin-bottom: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                <button id="test-data" class="test-btn">Populate Test Data</button>
            </div>
            <!-- Development Only - End -->

            <div class="form-group">
                <label for="customer-name" class="required-field">Your name:</label>
                <input type="text" id="customer-name" name="customer-name" required>
            </div>

            <div class="form-group">
                <label for="contact-number" class="required-field">Your contact number:</label>
                <input type="tel" id="contact-number" name="contact-number" required>
            </div>

            <div class="form-group">
                <label for="booking-date" class="required-field">Booking date:</label>
                <input type="date" id="booking-date" name="booking-date" required placeholder="Select date">
                <!-- <label for="booking-date" class="required-field">Booking Date: (<span id="meal-type">Dinner</span>)</label>
                <input type="hidden" id="meal" name="meal" value="dinner"> -->

                <span class="error-message" id="date-error"></span>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="adult-count" class="required-field">Number of Adults 👩🏻:</label>
                    <select id="adult-count" name="adult-count" required>
                        <option value="" disabled selected>Select number of adults</option>
                    </select>
                </div>
                <span class="error-message" id="adult-count-error"></span>

                <div class="form-group">
                    <label for="kid-count">Number of Children 🧒🏻: (age 5 to 12)</label>
                    <select id="kid-count" name="kid-count">
                        <option value="0" selected>0</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="toddler-count">Number of Toddlers 👶🏻: (age 4 or below)</label>
                    <select id="toddler-count" name="toddler-count">
                        <option value="0" selected>0</option>
                    </select>
                </div>
            </div>

            <!-- First, update the course count dropdown to have a proper initial value -->
            <div class="form-group course-count-group">
                <label for="course-count" class="required-field">Please choose the number of menu courses:</label>
                <select id="course-count" name="course-count" required>
                </select>
            </div>
        </div>
        
        <!-- Course sections follow -->
        <div class="course-section">
            <h2 class="course-title">Soups</h2>
            <p class="course-description">You can select up to 2 soup items for your guests to choose from...</p>
            <div class="selection-count" id="soups-count"></div>
            <span class="error-message" id="soups-quantity-error"></span>
            <div class="menu-items" id="soups"></div>
        </div>
        
        <div class="course-section">
            <h2 class="course-title">Starters</h2>
            <p class="course-description">Our starters are mainly designed to be shared and everyone will be served the same. We have quite a large variety of starters... you can savor more of them by choosing menu with more courses. :-)</p>
            <div class="selection-count" id="starters-count"></div>
            <span class="error-message" id="starters-quantity-error"></span>
            <div class="menu-items" id="starters"></div>
        </div>

        <div class="course-section">
            <h2 class="course-title">Main Courses</h2>
            <p class="course-description">For the main course, you have the option of individual plating or family-style. While individual plating is more common... family-style sharing can be more cozy with dish such as Signature Meat Platter where everyone can savor more than one choice of meat.</p>
            <div class="serving-style-selection">
                <label class="radio-label">
                    <input type="radio" name="serving-style" value="individual" checked>
                    <span>Individually Served</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="serving-style" value="sharing">
                    <span>Family-Style Sharing</span>
                </label>
            </div>
            <div id="sharing-helper-text" class="helper-text" style="display: none; margin-top: 10px; color: #666; font-style: italic;">
                (With more than 8 adult guests, 2 dishes can be selected for sharing.)
            </div>
            <div class="selection-count" id="mains-count"></div>
            <span class="error-message" id="mains-quantity-error"></span>            
            <div class="menu-items" id="mains"></div>
        </div>

        <div class="course-section">
            <h2 class="course-title">Desserts</h2>
            <p class="course-description">You can select up to 2 dessert items for your guests to choose from...</p>
            <div class="selection-count" id="desserts-count"></div>
            <span class="error-message" id="desserts-quantity-error"></span>
            <div class="menu-items" id="desserts"></div>
        </div>

        <!-- Add Specifics section -->
        <div class="course-section">
            <h2 class="course-title">Additional Information</h2>
            <div class="form-group">
                <label for="allergies">Is there any food allergies or restrictions we should be aware of?</label>
                <textarea id="allergies" name="allergies" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="occasion">If this is for any special occassion (e.g. birthday celebration 🎂), you can let us know:</label>
                <textarea id="occasion" name="occasion" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Special requests (click any that applies):</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="special-requests" value="bigger-portion">
                        <span>Bigger portion please</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="special-requests" value="lactose-intolerant">
                        <span>Some guest(s) is vegetarian</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="special-requests" value="vegetarian">
                        <span>Some guest(s) cannot take diaries such as cheese or cream</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="special-requests" value="high-chair">
                        <span>Need high chair</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="special-requests" value="wheelchair-access">
                        <span>Need wheelchair access</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="special-requests" value="has-pet">
                        <span>Has pet</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="special-requests" value="others">
                        <span>Others:</span>
                        <input type="text" name="special-requests-others" style="margin-left: 10px;">
                    </label>
                </div>
            </div>
        </div>
        <div class="summary">
            <h2 id="summary-heading">You have selected the <span id="course-count-display">0</span> course menu (<span id="menu-price-display">$0</span>) with the following dishes:</h2>
            <div id="selected-items"></div>
            <div class="button-group">
                <button id="send-email" class="send-email-btn">Send Menu Selection</button>
                <button id="send-whatsapp" class="whatsapp-btn">Submit (via WhatsApp)</button>
            </div>
        </div>
    </div>

    <script>

        const MAX_CAPACITY = 18;
        const MAX_CHILDREN = 9;

        // Configuration object for course selections
        const courseConfig = {
            soups: {
                maxSelections: 2,
                allowMultiple: true,
                displayName: 'Soups',
                required: true
            },
            starters: {
                maxSelections: 2,
                allowMultiple: true,
                displayName: 'Starters',
                required: true
            },
            mains: {
                maxSelections: 2,
                allowMultiple: true,
                displayName: 'Main Courses',
                required: true
            },
            desserts: {
                maxSelections: 2,
                allowMultiple: true,
                displayName: 'Desserts',
                required: true
            }
        };

        // Initialize selectedItems based on configuration
        const selectedItems = Object.keys(courseConfig).reduce((acc, category) => {
            acc[category] = courseConfig[category].allowMultiple ? [] : null;
            return acc;
        }, {});        

        // Menu prices configuration
        const menuPrices = {
            4: 448,
            5: 580,
            6: 638,
            7: 688,
            8: 728
        };

        // Define course count availability
        let courseCountAvailability = {
            4: { label: '4 Course Lunch Menu - 1 starters ($448)', meals: ['lunch'], isDefault: true },
            5: { label: '5 Course Menu - 2 starters ($580)', meals: ['both'], isDefault: false },
            6: { label: '6 Course Menu - 3 starters ($638)', meals: ['both'], isDefault: true },
            7: { label: '7 Course Menu - 4 starters ($688)', meals: ['both'], isDefault: false },
            8: { label: '8 Course Menu - 5 starters ($728)', meals: ['both'], isDefault: false }
        };

        // Track current menu price
        let currentMenuPrice = 0;

        // Track current serving style
        let currentServingStyle = 'individual';

        async function fetchMenuData() {
            try {
                const PUBLISHED_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQp_lmQ3G1BBHVC5Lotsbtid6IO9kA83VGmKeI2e_Q31_LXtsFM8v2ZyvloRxo7FMixbu46ofyPq9JF/pub?gid=0&single=true&output=csv';
                
                // Add cache-busting parameter
                const timestamp = new Date().getTime();
                const urlWithCacheBust = `${PUBLISHED_CSV_URL}&_=${timestamp}`;
                
                console.log('Fetching menu data...');

                // Try proxy services first
                const proxyServices = [
                    'https://corsproxy.io/?',
                    'https://api.allorigins.win/raw?url=',
                    'https://api.codetabs.com/v1/proxy?quest='
                ];

                // Try each proxy service in sequence
                for (const proxy of proxyServices) {
                    try {
                        const proxyUrl = proxy + encodeURIComponent(urlWithCacheBust);
                        console.log(`Trying proxy: ${proxy}`);

                        const response = await fetch(proxyUrl);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const csvText = await response.text();
                        if (!csvText || csvText.trim() === '') {
                            throw new Error('Empty response received');
                        }

                        console.log('Successfully fetched CSV data through proxy');
                        return new Promise((resolve, reject) => {
                            Papa.parse(csvText, {
                                header: true,
                                skipEmptyLines: true,
                                complete: function(results) {
                                    if (results.data && results.data.length > 0) {
                                        // Debug: Log the first few rows of raw data
                                        console.log('Raw CSV data (first 3 rows):', results.data.slice(0, 3));
                                        resolve(processCSVData(results.data));
                                    } else {
                                        reject(new Error('No data found in CSV'));
                                    }
                                },
                                error: function(error) {
                                    reject(error);
                                }
                            });
                        });
                    } catch (error) {
                        console.log(`Failed with proxy ${proxy}, trying next...`, error);
                        continue;
                    }
                }

                // If all proxies fail, try direct fetch as last resort
                try {
                    console.log('Trying direct fetch as last resort...');
                    const response = await fetch(urlWithCacheBust);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const csvText = await response.text();
                    if (!csvText || csvText.trim() === '') {
                        throw new Error('Empty response received');
                    }

                    console.log('Successfully fetched CSV data directly');
                    return new Promise((resolve, reject) => {
                        Papa.parse(csvText, {
                            header: true,
                            skipEmptyLines: true,
                            complete: function(results) {
                                if (results.data && results.data.length > 0) {
                                    // Debug: Log the first few rows of raw data
                                    console.log('Raw CSV data (first 3 rows):', results.data.slice(0, 3));
                                    resolve(processCSVData(results.data));
                                } else {
                                    reject(new Error('No data found in CSV'));
                                }
                            },
                            error: function(error) {
                                reject(error);
                            }
                        });
                    });
                } catch (error) {
                    console.log('Direct fetch failed:', error);
                }

                throw new Error('All fetch attempts failed');
            } catch (error) {
                console.error('Error fetching menu data:', error);
                document.querySelector('.container').innerHTML += `
                    <div class="error">Error loading menu data: ${error.message}</div>
                `;
                return null;
            }
        }

        function processCSVData(csvData) {
            const menuData = {
                soups: [],
                starters: [],
                mains: {
                    individual: [],
                    sharing: []
                },
                desserts: []
            };

            // Default placeholder image from a reliable source
            const defaultImage = 'https://placehold.co/150x150';

            // Function to convert Google Drive URL to direct image URL
            function getDirectImageUrl(driveUrl) {
                if (!driveUrl) return defaultImage;
                
                // If it's not a Google Drive URL, return it as is
                if (!driveUrl.includes('drive.google.com')) {
                    return driveUrl;
                }

                // Handle Google Drive URLs
                const fileId = driveUrl.match(/[-\w]{25,}/);
                if (fileId) {
                    return `https://drive.google.com/thumbnail?id=${fileId[0]}&sz=w1000`;
                }

                // If we can't process the Google Drive URL, return default
                return defaultImage;
            }

            csvData.forEach(row => {
                // Skip empty rows or rows without required fields
                if (!row.Category || !row.ID || !row.Name) return;

                // Debug logging - show all column values for this row
                console.log(`Processing item: ${row.Name}`);
                console.log('Row data:', row);

                // Skip inactive items - handle different possible boolean values
                const isActive = row.IsActive?.toUpperCase();
                console.log(`IsActive value for ${row.Name}: "${row.IsActive}" (normalized: "${isActive}")`);
                
                if (isActive !== 'TRUE' && isActive !== '1' && isActive !== 'YES') {
                    console.log(`Skipping inactive item: ${row.Name}`);
                    return;
                }

                const item = {
                    id: row.ID,
                    name: row.Name,
                    description: row.Description || '',
                    image: getDirectImageUrl(row['Image URL']),
                    upgradePrice: parseFloat(row['Upgrade Price']) || 0,
                    additionalRemarks: row.AdditionalRemarks || '', // Add this line
                    servingStyle: (row['ServingStyle'] || 'individual').toLowerCase().trim(), // Normalize serving style
                    isSignature: row.IsSignature?.toUpperCase() === 'TRUE' || row.IsSignature?.toUpperCase() === 'YES' || row.IsSignature === '1',
                    mealAvailability: (row['MealAvailability'] || 'Both').toLowerCase().trim() // Add meal availability
                };

                const categoryKey = row.Category.toLowerCase().replace(/\s+/g, '');
                if (categoryKey === 'mains') {
                    // Add to appropriate mains array based on serving style
                    if (item.servingStyle === 'sharing') {
                        menuData.mains.sharing.push(item);
                    } else {
                        menuData.mains.individual.push(item);
                    }
                } else if (menuData[categoryKey]) {
                    menuData[categoryKey].push(item);
                }
            });

            return menuData;
        }

        // Function to create menu item elements
        function createMenuItem(item, category) {
            const div = document.createElement('div');
            div.className = 'menu-item';
            div.dataset.id = item.id;
            div.dataset.category = category;
            
            // Add quantity dropdown (initially hidden)
            const quantityDropdown = `
                <select class="quantity-select" data-item-id="${item.id}" style="display: none; position: absolute; bottom: 15px; left: 15px; width: 190px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.7em;">
                    <option value="" disabled selected>Specify quantity if you know</option>
                </select>
            `;

            div.innerHTML = `
                <input type="checkbox" id="item-${item.id}" ${selectedItems[category].includes(item) ? 'checked' : ''}>
                <img src="${item.image}" alt="${item.name}" onerror="this.src='https://placehold.co/150x150'" class="menu-image";">
                <h3>${item.name}${item.isSignature ? ' ⭐' : ''}</h3>
                <p>${item.description}
                ${item.upgradePrice > 0 ? `<b><class="price-upgrade">(+$${item.upgradePrice.toFixed(2)} per guest)</b>` : ''}
                </p>
                ${item.additionalRemarks ? `
                    <div class="ribbon">
                        <span>${item.additionalRemarks}</span>
                    </div>
                ` : ''}
            `;

            if (category !== 'starters' && currentServingStyle !== 'sharing')
            {
                div.innerHTML += quantityDropdown;

                // Initialize quantity dropdown options
                updateQuantityDropdown(div);
            }

            // Conditionally hide items based on meal availability
            const urlParams = new URLSearchParams(window.location.search);
            const mealType = (urlParams.get('meal') || 'dinner').toLowerCase(); // Default to dinner
            if (item.mealAvailability !== 'both' && item.mealAvailability !== mealType) {
                div.style.display = 'none';
            }

            const checkbox = div.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', () => {
                if (!div.classList.contains('disabled')) {
                    selectItem(item, category, div);
                }
            });

            // Add event listener to quantity dropdown
            const selectElement = div.querySelector('.quantity-select');
            if (selectElement != null)
            {
                selectElement.addEventListener('change', (event) => {
                    handleQuantityChange(event, item.id);
                });
            }
 
            // Add click event for the entire menu item div
            div.addEventListener('click', () => {
                if (!event.target.matches('input[type="checkbox"]') && !event.target.matches('select.quantity-select')) {

                    if (!checkbox.disabled)
                    {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                    }
                }
            });

            return div;
        }

        // Function to update quantity dropdown options
        function updateQuantityDropdown(menuItemElement) {
            const adultCount = parseInt(document.getElementById('adult-count').value) || 0;
            const selectElement = menuItemElement.querySelector('.quantity-select');
            if (!selectElement) return;

            // Clear existing options and add default option (if not starters)
            selectElement.innerHTML = '<option value="" disabled selected>[Optional] #Guests having this?</option>';

            // Add options from 0 to adultCount
            for (let i = 0; i <= adultCount; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                selectElement.appendChild(option);
            }

            // Update selected value if it exceeds the new maximum (and not starters)
            if (menuItemElement.dataset.category !== 'starters') {
                const currentValue = parseInt(selectElement.value);
                if (currentValue > adultCount) {
                    selectElement.value = adultCount;
                }
            }

            // If it's starters and there's a selected value, keep it
            if (menuItemElement.dataset.category === 'starters' && selectElement.value === "") {
                selectElement.value = 1; // Default to 1 for starters
            }

            clearItemQuantities();
        }

        // Function to handle quantity change
        function handleQuantityChange(event, itemId) {
            const category = event.target.closest('.menu-item').dataset.category;
            const quantity = parseInt(event.target.value);
            itemQuantities[itemId] = quantity;
            updateSummary();
        }

        // Initialize item quantities object
        const itemQuantities = {};

        // Function to get quantity for an item
        function getItemQuantity(itemId) {
            return itemQuantities[itemId] || 0;
        }

        // Function to clear item quantities
        function clearItemQuantities() {
            Object.keys(itemQuantities).forEach(key => delete itemQuantities[key]);
        }

        function updateSelectionCount(category) {
            const config = courseConfig[category];
            if (!config.allowMultiple) return;

            const countElement = document.getElementById(`${category}-count`);
            if (!countElement) return;

            const selectedCount = selectedItems[category].length;
            const maxCount = config.maxSelections;
            
            countElement.textContent = `Please select up to ${maxCount} ${config.displayName.toLowerCase()} (${selectedCount} selected)`;
            
            // Remove all state classes first
            countElement.classList.remove('error', 'partial-success', 'success');
            
            // Add appropriate state class
            if (selectedCount == 0 || selectedCount > maxCount) {
                countElement.classList.add('error');
            } else if (selectedCount < maxCount) {
                countElement.classList.add('partial-success');
            } else {
                countElement.classList.add('success');
            }

            // Disable unselected items if max is reached
            const menuItems = document.querySelectorAll(`#${category} .menu-item`);
            menuItems.forEach(item => {
                if (!item.classList.contains('selected')) {
                    item.classList.toggle('disabled', selectedCount >= maxCount);
                    item.querySelector('input[type="checkbox"]').disabled = item.classList.contains('disabled');
                }
            });
        }

        function selectItem(item, category, element) {
            const config = courseConfig[category];
            if (config.allowMultiple) {
                const isSelected = element.classList.contains('selected');
                const currentSelections = selectedItems[category].length;
                
                if (isSelected) {
                    element.classList.remove('selected');
                    element.classList.remove('error');
                    selectedItems[category] = selectedItems[category].filter(i => i.id !== item.id);
                    element.querySelector('input[type="checkbox"]').checked = false;

                    // Reset quantity
                    const selectElement = element.querySelector('.quantity-select');
                    if (selectElement)
                    {
                        selectElement.style.display = 'none';
                    }
                } else {
                    if (currentSelections < config.maxSelections) {
                        element.classList.add('selected');
                        selectedItems[category].push(item);
                        element.querySelector('input[type="checkbox"]').checked = true;
                    }

                    const selectElement = element.querySelector('.quantity-select');
                    if (selectElement)
                    {
                        // Show quantity dropdown
                        element.querySelector('.quantity-select').style.display = 'block';
                    }
                }
                
                updateSelectionCount(category);
            } else {
                document.querySelectorAll(`#${category} .menu-item`).forEach(el => {
                    el.classList.remove('selected');
                    el.querySelector('input[type="checkbox"]').checked = false;
                });
                
                // Hide quantity dropdown
                //element.querySelector('.quantity-select').style.display = 'none';
                // const selectElement = element.querySelector('.quantity-select');
                // if (selectElement) {
                //     // Force a visual update
                //     selectElement.dispatchEvent(new Event('change'));
                // }

                element.classList.add('selected');
                element.querySelector('input[type="checkbox"]').checked = true;
                selectedItems[category] = item;

                if (category != "starters")
                {
                    // Show quantity dropdown
                    element.querySelector('.quantity-select').style.display = 'block';
                }                
            }
            
            updateSummary();

            // Update button states after selection changes
            updateButtonStates();
        }

        function updateSummary() {
            const summaryElement = document.getElementById('selected-items');
            const adultCount = parseInt(document.getElementById('adult-count').value) || 0;
            let html = '';

            Object.entries(courseConfig).forEach(([category, config]) => {
                const categoryDisplayName = config.displayName;
                if (category === 'specifics') {
                    // Specifics are handled separately below
                    return;
                }

                // Existing course item handling

                const items = selectedItems[category];
                if (!items || (Array.isArray(items) && items.length === 0)) return;

                html += `<p><strong>${categoryDisplayName}:</strong></p>`;

                if (Array.isArray(items)) {
                    let totalQuantity = 0;
                    items.forEach(item => {
                        if (!item.disabled)
                        {
                            const quantity = getItemQuantity(item.id);
                            totalQuantity += quantity;
                            html += `<p>• ${item.name} ${quantity > 0 ? `(x${quantity})` : ''} ${item.upgradePrice > 0 ? `(+$${item.upgradePrice.toFixed(2)} per guest)` : ''} </p>`;
                        }
                    });

                    // Check if total quantity exceeds adult count
                    const errorElement = document.getElementById(`${category}-quantity-error`);
                    if (totalQuantity > adultCount) {
                        errorElement.textContent = `Total quantity exceeds the number of adults (${adultCount}).`;
                        items.forEach(item => {
                            const menuItemDiv = document.querySelector(`.menu-item[data-id="${item.id}"]`);
                            if (menuItemDiv) menuItemDiv.classList.add('error');
                        });
                        errorElement.style.display = 'block';
                    } else {
                        items.forEach(item => {
                            const menuItemDiv = document.querySelector(`.menu-item[data-id="${item.id}"]`);
                            if (menuItemDiv) menuItemDiv.classList.remove('error');
                        });
                        errorElement.textContent = '';
                        errorElement.style.display = 'none';
                    }
                } else {
                    const quantity = getItemQuantity(items.id);
                    html += `<p>• ${items.name} ${quantity > 0 ? `(x${quantity})` : ''} ${items.upgradePrice > 0 ? `(+$${items.upgradePrice.toFixed(2)} per guest)` : ''} </p>`;
                }
            });

            // Validate quantities and update button states
            validateQuantities();
            updateButtonStates();


            // Add specifics to the summary
            const allergies = document.getElementById('allergies').value;
            const occasion = document.getElementById('occasion').value;
            const specialRequests = Array.from(document.querySelectorAll('input[name="special-requests"]:checked'))
                .map(checkbox => checkbox.nextElementSibling.textContent.trim());
            const othersRequest = document.querySelector('input[name="special-requests-others"]').value;

            if (allergies) {
                html += `<p><strong>Allergies/Restrictions:</strong> ${allergies}</p>`;
            }
            if (occasion) {
                html += `<p><strong>Occasion:</strong> ${occasion}</p>`;
            }
            if (specialRequests.length > 0 || othersRequest) {
                html += `<p><strong>Special Requests:</strong> ${specialRequests.filter(req => req !== 'Others:').join(', ')} ${othersRequest ? othersRequest : ''}</p>`;
            }

            summaryElement.innerHTML = html;
        }

        function validateQuantities() {
            const adultCount = parseInt(document.getElementById('adult-count').value) || 0;
            let isValid = true;

            Object.entries(courseConfig).forEach(([category, config]) => {
                if (config.allowMultiple) {
                    const items = selectedItems[category];
                    if (items && Array.isArray(items)) {
                        let totalQuantity = 0;
                        items.forEach(item => {
                            totalQuantity += getItemQuantity(item.id);
                        });

                        const errorElement = document.getElementById(`${category}-quantity-error`);
                        if (totalQuantity > adultCount) {
                            errorElement.textContent = `Total quantity for ${config.displayName} (${totalQuantity}) exceeds the number of adults (${adultCount}).`;
                            errorElement.style.display = 'block';
                            isValid = false;
                        } else {
                            errorElement.textContent = '';
                            errorElement.style.display = 'none';
                        }
                    }
                }
            });

            return isValid;
        }

        // Add CSS for error messages
        const style = document.createElement('style');
        style.textContent += `
            .error-message {
                display: none; /* Initially hidden */
            }
        `;

        function initializeSelectionCounts() {
            Object.keys(courseConfig).forEach(category => {
                if (courseConfig[category].allowMultiple) {
                    updateSelectionCount(category);
                }
            });
        }

        function updateMainCourseDisplay() {
            const mainsContainer = document.getElementById('mains');
            const menuData = window.menuData; // Store menuData in window for access

            if (!menuData) return;

            // Clear existing items
            mainsContainer.innerHTML = '';

            // Get the current serving style
            const servingStyle = document.querySelector('input[name="serving-style"]:checked').value;
            currentServingStyle = servingStyle;

            // Update max selections based on serving style and adult count
            if (servingStyle === 'sharing') {
                const adultCount = parseInt(document.getElementById('adult-count').value) || 0;
                courseConfig.mains.maxSelections = adultCount > 8 ? 2 : 1;
            } else {
                courseConfig.mains.maxSelections = 2; // Default for individual
            }

            // Display items for the selected serving style
            const items = menuData.mains[servingStyle];
            if (items && items.length > 0) {
                items.forEach(item => {
                    mainsContainer.appendChild(createMenuItem(item, 'mains'));
                });
            } else {
                mainsContainer.innerHTML = '<div class="error">No items available for this serving style</div>';
            }

            // Update selection count display
            updateSelectionCount('mains');
        }

        // Add event listener for serving style change
        document.querySelectorAll('input[name="serving-style"]').forEach(radio => {
            radio.addEventListener('change', () => {
                // Remove selected class from all labels
                document.querySelectorAll('.radio-label').forEach(label => {
                    label.classList.remove('selected');
                });
                
                // Add selected class to the checked label
                const checkedLabel = document.querySelector('input[name="serving-style"]:checked').closest('.radio-label');
                if (checkedLabel) {
                    checkedLabel.classList.add('selected');
                }
                
                // Show/hide helper text based on serving style
                const helperText = document.getElementById('sharing-helper-text');
                const isSharing = document.querySelector('input[name="serving-style"]:checked').value === 'sharing';
                helperText.style.display = isSharing ? 'block' : 'none';
                
                // Clear all mains selections regardless of which style is selected
                selectedItems.mains = [];
                // Clear quantities
                //clearItemQuantities();
                
                // Update display
                updateMainCourseDisplay();
                
                // Update selection count
                updateSelectionCount('mains');
                
                updateSummary();
                updateButtonStates(); // Call updateButtonStates after serving style change
            });
        });

        // Add event listener for adult count change
        document.getElementById('adult-count').addEventListener('change', () => {
            // Only update if Family Style Sharing is selected
            if (currentServingStyle === 'sharing') {
                updateMainCourseDisplay();
                // Update helper text visibility
                updateSummary();
                updateButtonStates();
                const helperText = document.getElementById('sharing-helper-text');
                helperText.style.display = 'block';
            }
            
            // Update quantity dropdowns for all menu items
            document.querySelectorAll('.menu-item').forEach(menuItem => {
                updateQuantityDropdown(menuItem);
            });
        });

        // Initialize the selected state and helper text
        window.addEventListener('DOMContentLoaded', () => {
            const checkedLabel = document.querySelector('input[name="serving-style"]:checked').closest('.radio-label');
            if (checkedLabel) {
                checkedLabel.classList.add('selected');
            }
            
            // Initialize helper text visibility
            const helperText = document.getElementById('sharing-helper-text');
            const isSharing = document.querySelector('input[name="serving-style"]:checked').value === 'sharing';
            helperText.style.display = isSharing ? 'block' : 'none';
        });

        function updateTitleBasedOnQueryParam() {
            const urlParams = new URLSearchParams(window.location.search);
            const mealType = urlParams.get('meal');

            if (mealType && mealType.toLowerCase() === 'lunch') {
                populateCourseCountDropdown('lunch');                
            } else {
                populateCourseCountDropdown('dinner');
            }
        }
        
        // Call the function on page load
        updateTitleBasedOnQueryParam();

        function populateCourseCountDropdown(mealType) {
            const courseCountSelect = document.getElementById('course-count');
            courseCountSelect.innerHTML = ''; // Clear existing options

            let defaultSelected = false;

            for (const count in courseCountAvailability) {
                const { label, meals } = courseCountAvailability[count];
                if (meals.includes('both') || meals.includes(mealType)) {
                    const option = document.createElement('option');
                    option.value = count;
                    option.textContent = label;

                    // Set default selection based on isDefault attribute
                    if (courseCountAvailability[count].isDefault && !defaultSelected) {
                        option.selected = true;
                        defaultSelected = true;
                    }

                    courseCountSelect.appendChild(option);
                }
            }

            // If no default was set (e.g., only dinner options and it's lunch), select the first available option
            if (!defaultSelected && courseCountSelect.options.length > 0) {
                courseCountSelect.options[0].selected = true;
            }

            // Dispatch a change event to trigger related updates
            courseCountSelect.dispatchEvent(new Event('change'));
        }


        
        async function initializeMenu() {
            try {
                console.log('Starting menu initialization...');
                
                document.querySelectorAll('.menu-items').forEach(el => {
                    el.innerHTML = '<div class="loading">Loading menu items...</div>';
                });

                const menuData = await fetchMenuData();
                console.log('Menu data received:', menuData);

                if (menuData) {
                    // Store menuData in window for access
                    window.menuData = menuData;

                    for (const [category, items] of Object.entries(menuData)) {
                        if (category === 'mains') {
                            // Handle mains separately
                            updateMainCourseDisplay();
                        } else {
                            const container = document.getElementById(category);
                            if (container) {
                                container.innerHTML = '';
                                console.log(`Processing category ${category} with ${items.length} items`);
                                
                                if (items.length === 0) {
                                    container.innerHTML = '<div class="error">No items found for this category</div>';
                                } else {
                                    items.forEach(item => {
                                        container.appendChild(createMenuItem(item, category));
                                    });
                                }
                            } else {
                                console.warn(`Container not found for category: ${category}`);
                            }
                        }
                    }
                } else {
                    throw new Error('No menu data returned');
                }
            } catch (error) {
                console.error('Initialization error:', error);
                document.querySelector('.container').innerHTML += `
                    <div class="error">Error initializing menu: ${error.message}</div>
                `;
            }
        }

        function updateBookingDateLabel() {
            const urlParams = new URLSearchParams(window.location.search);
            const mealType = (urlParams.get('meal') || 'dinner').toLowerCase();
            const mealTypeDisplay = mealType.charAt(0).toUpperCase() + mealType.slice(1); // Capitalize first letter
            const label = document.querySelector('label[for="booking-date"].required-field');
            const mealInput = document.getElementById('meal');

            if (label) {
                label.textContent = `Booking Date: (${mealTypeDisplay})`;
            }
            if (mealInput) {
                mealInput.value = mealType;
            }
        }
        function setupDatePicker() {
            console.log("setupDatePicker");
            const dateInput = document.getElementById('booking-date');
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const maxDate = new Date();
            maxDate.setMonth(maxDate.getMonth() + 3);

            const formatDate = (date) => {
                const d = new Date(date);
                let month = '' + (d.getMonth() + 1);
                let day = '' + d.getDate();
                const year = d.getFullYear();

                if (month.length < 2) month = '0' + month;
                if (day.length < 2) day = '0' + day;

                return [year, month, day].join('-');
            };

            dateInput.min = formatDate(tomorrow);
            dateInput.max = formatDate(maxDate);

            dateInput.addEventListener('change', (e) => {
                const selectedDate = new Date(e.target.value);
                const errorElement = document.getElementById('date-error');

                if (selectedDate < tomorrow || selectedDate > maxDate) {
                    errorElement.textContent = 'Please select a date within the next 3 months (excluding today)';
                    e.target.value = '';
                } else {
                    errorElement.textContent = '';
                }
            });
        }

        function setupNumberSelects() {
            const adultSelect = document.getElementById('adult-count');
            const kidSelect = document.getElementById('kid-count');


            console.log("setupNumberSelects");
            // Populate adult count options
            for (let i = 2; i <= MAX_CAPACITY; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                adultSelect.appendChild(option);
            }

            // Populate kid count options
            for (let i = 1; i <= 9; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                kidSelect.appendChild(option);
            }

            // Setup toddler count select
            const toddlerSelect = document.getElementById('toddler-count');
            for (let i = 1; i <= 9; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                toddlerSelect.appendChild(option);
            }

            // Add event listeners for adult and kid count changes
            adultSelect.addEventListener('change', validateAdultKidCount);
            kidSelect.addEventListener('change', validateAdultKidCount);

            // Initial validation
            validateAdultKidCount();
        }

        function validateAdultKidCount() {
            const adultCount = parseInt(document.getElementById('adult-count').value) || 0;
            const kidCount = parseInt(document.getElementById('kid-count').value) || 0;
            const totalCount = adultCount + kidCount;
            const errorElement = document.getElementById('adult-count-error');

            if (totalCount > MAX_CAPACITY) {
                errorElement.textContent = 'The combined number of adults and kids cannot exceed ' + MAX_CAPACITY;
                // You can also visually indicate the error on the select elements themselves
                document.getElementById('adult-count').classList.add('error-field');
                document.getElementById('kid-count').classList.add('error-field');
            } else {
                errorElement.textContent = '';
                document.getElementById('adult-count').classList.remove('error-field');
                document.getElementById('kid-count').classList.remove('error-field');
            }

            // Update button states based on validation
            updateButtonStates();
        }

        // Add CSS for error indication on select elements
        style.textContent = `
            .error-field {
                border-color: #e74c3c !important; /* Red border */
            }
        `;
        document.head.appendChild(style);

        function setupFormValidation() {
            const requiredFields = [
                'customer-name',
                'contact-number',
                'booking-date',
                'adult-count',
                'course-count'
            ];

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateButtonStates);
                    field.addEventListener('change', updateButtonStates);
                }
            })
        }

        function handleCourseCountChange(event) {
            const selectedValue = event.target.value;
            if (selectedValue) {
                const totalCourses = parseInt(selectedValue);
                currentMenuPrice = menuPrices[totalCourses];
                console.log(`Selected ${totalCourses} course menu at $${currentMenuPrice}`);
                
                // Update the course count and price display
                document.getElementById('course-count-display').textContent = totalCourses;
                document.getElementById('menu-price-display').textContent = `$${currentMenuPrice}`;
                
                switch(totalCourses) {
                    case 4:
                        courseConfig.starters.maxSelections = 1;
                        break;
                    case 5:
                        courseConfig.starters.maxSelections = 2;
                        break;
                    case 6:
                        courseConfig.starters.maxSelections = 3;
                        break;
                    case 7:
                        courseConfig.starters.maxSelections = 4;
                        break;
                    case 8:
                        courseConfig.starters.maxSelections = 5;
                        break;
                    default:
                        courseConfig.starters.maxSelections = 2;
                }

                courseConfig.soups.maxSelections = 2;
                courseConfig.mains.maxSelections = 2;
                courseConfig.desserts.maxSelections = 2;

                /*
                console.log(`Updated starters max selections to: ${courseConfig.starters.maxSelections}`);

                Object.keys(selectedItems).forEach(category => {
                    if (Array.isArray(selectedItems[category])) {
                        selectedItems[category] = [];
                    } else {
                        selectedItems[category] = null;
                    }
                });

                initializeSelectionCounts();
                updateSummary();
                
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('selected', 'disabled');
                });
                */

                updateAllSelectionCounts();
            } else {
                currentMenuPrice = 0;
                updateSummary();
            }
        }

        function setupCourseCount() {
            const courseCountSelect = document.getElementById('course-count');
            
            courseCountSelect.addEventListener('change', handleCourseCountChange);
            
            if (courseCountSelect.value) {
                const event = new Event('change');
                courseCountSelect.dispatchEvent(event);
            }
        }

        function updateAllSelectionCounts() {
            Object.keys(courseConfig).forEach(category => {
                if (courseConfig[category].allowMultiple) {
                    updateSelectionCount(category);
                }
            });
        }

        // Function to show enlarged image
        function showEnlargedImage(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const closeBtn = document.querySelector('.close-modal');

            modal.style.display = "block";
            modalImg.src = imageUrl;

            // Close modal when clicking the close button
            closeBtn.onclick = function() {
                modal.style.display = "none";
            }

            // Close modal when clicking outside the image
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            }

            // Close modal when pressing Escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === "Escape") {
                    modal.style.display = "none";
                }
            });
        }

        // Function to check form validity and update button states
        function updateButtonStates() {
            const name = document.getElementById('customer-name').value;
            const contactNumber = document.getElementById('contact-number').value;
            const bookingDate = document.getElementById('booking-date').value;
            const adultCount = document.getElementById('adult-count').value;
            const courseCount = document.getElementById('course-count').value;

            let isValid = name && contactNumber && bookingDate && adultCount && courseCount && validateQuantities();

            // Check if required menu items are selected
            if (isValid) {
                for (const category in courseConfig) {
                    if (courseConfig[category].required) {
                        const selected = selectedItems[category];
                        if (courseConfig[category].allowMultiple) {
                            isValid = isValid && (selected && selected.length >= 1 && selected.length <= courseConfig[category].maxSelections);
                        } else {
                            isValid = isValid && (selected !== null);
                        }
                        if (!isValid) break; // No need to check further if one category is invalid
                    }
                }
            }


            // Update all email and WhatsApp buttons
            const emailButtons = document.querySelectorAll('.send-email-btn');
            const whatsappButtons = document.querySelectorAll('.whatsapp-btn');

            emailButtons.forEach(button => {
                button.disabled = !isValid;
            });

            whatsappButtons.forEach(button => {
                button.disabled = !isValid;
            });
        }

        // Add event listeners to required fields
        function setupFormValidation() {
            const requiredFields = [
                'customer-name',
                'contact-number',
                'booking-date',
                'adult-count',
                'course-count'
            ];

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateButtonStates);
                    field.addEventListener('change', updateButtonStates);
                }
            });

            // Initial check
            updateButtonStates();
        }

        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded, initializing menu...');
            setupDatePicker();
            setupNumberSelects();
            setupCourseCount();
            setupFormValidation();
            initializeMenu();
            updateBookingDateLabel();
            initializeSelectionCounts();
            
            // Pre-populate form fields for testing
            const urlParams = new URLSearchParams(window.location.search);
            const customerNameParam = urlParams.get('CustomerName');
            if (customerNameParam) {
                document.getElementById('customer-name').value = customerNameParam;
            }

            const contactNumberParam = urlParams.get('ContactNumber');
            if (contactNumberParam) {
                document.getElementById('contact-number').value = contactNumberParam;
            }

            const bookingDateParam = urlParams.get('BookingDate');
            if (bookingDateParam) {
                document.getElementById('booking-date').value = bookingDateParam;
            }

            const numAdultsParam = urlParams.get('NumAdults');
            console.log(`NumAdultsParam: ${numAdultsParam}`);
            if (numAdultsParam) {
                console.log(`Setting adult count to ${numAdultsParam}`);
                document.getElementById('adult-count').value = numAdultsParam;
            }
            
            // Trigger the course count change event to initialize the display
            const courseCountSelect = document.getElementById('course-count');
            const event = new Event('change');
            courseCountSelect.dispatchEvent(event);
            
            // Trigger form validation to update button states
            updateButtonStates();
            
            updateSummary();
        });

        // Enable/disable "Others" text input based on checkbox in the "Additional Information" section
        const othersCheckbox = document.querySelector('input[name="special-requests"][value="others"]');
        const othersTextInput = document.querySelector('input[name="special-requests-others"]');

        if (othersCheckbox && othersTextInput) {
            othersCheckbox.addEventListener('change', function() {
                othersTextInput.disabled = !this.checked;
            });

            // Initialize state on page load
            othersTextInput.disabled = !othersCheckbox.checked;
        }

        // Add event listeners to Specifics inputs for immediate summary update
        document.getElementById('allergies').addEventListener('input', updateSummary);
        document.getElementById('occasion').addEventListener('input', updateSummary);
        document.querySelectorAll('input[name="special-requests"]').forEach(input => {
            input.addEventListener('change', updateSummary);
        });
        document.querySelector('input[name="special-requests-others"]').addEventListener('input', updateSummary);



        // Initialize EmailJS with your public key
        (function() {
            emailjs.init("THRDFTRmfAZfOf6rF"); // Replace with your EmailJS public key
        })();

        // Function to send email
        async function sendEmail() {
            const button = document.getElementById('send-email');
            button.disabled = true;
            button.textContent = 'Sending...';

            try {
                // Get form data
                const name = document.getElementById('customer-name').value;
                const contactNumber = document.getElementById('contact-number').value;
                const bookingDate = document.getElementById('booking-date').value;
                const adultCount = document.getElementById('adult-count').value;
                const kidCount = document.getElementById('kid-count').value || '0';
                const toddlerCount = document.getElementById('toddler-count').value || '0';
                const courseCount = document.getElementById('course-count').value;

                // Validate required fields
                if (!name || !contactNumber || !bookingDate || !adultCount || !courseCount) {
                    throw new Error('Please fill in all required fields');
                }

                // Get selected items
                const selectedItemsHtml = document.getElementById('selected-items').innerHTML;
                const courseCountDisplay = document.getElementById('course-count-display').textContent;
                const menuPriceDisplay = document.getElementById('menu-price-display').textContent;

                // Format the selected items for email
                const formattedItems = selectedItemsHtml
                    .replace(/<p>/g, '')
                    .replace(/<\/p>/g, '\n')
                    .replace(/<strong>/g, '')
                    .replace(/<\/strong>/g, '');

                // Prepare email template parameters
                const templateParams = {
                    from_name: name,
                    contact_number: contactNumber,
                    booking_date: bookingDate,
                    adult_count: adultCount,
                    kid_count: kidCount,
                    toddler_count: toddlerCount,
                    course_count: courseCountDisplay,
                    menu_price: menuPriceDisplay,
                    selected_items: formattedItems,
                    message: `New menu selection from ${name}\n\nContact: ${contactNumber}\nBooking Date: ${bookingDate}\nAdults: ${adultCount}\nKids: ${kidCount}\nToddlers: ${toddlerCount}\n\nSelected Menu:\n${formattedItems}`
                };
                
                console.log("Email parameters:", templateParams);
                console.log('Sending email with params:', templateParams);

                // Send email
                const response = await emailjs.send('service_7dw383m', 'template_uckqo2e', templateParams);
                console.log('Email sent successfully:', response);
                
                alert('Menu selection has been sent successfully!');
            } catch (error) {
                console.error('Error sending email:', error);
                alert(error.message || 'Failed to send menu selection. Please try again.');
            } finally {
                button.disabled = false;
                button.textContent = 'Send Menu Selection';
            }
        }

        // Add click event listener to the send email button
        document.getElementById('send-email').addEventListener('click', sendEmail);

        // Add click event listener to the top send email button
        document.getElementById('send-email-top').addEventListener('click', sendEmail);

        // Function to send WhatsApp message
        function sendWhatsApp() {
            try {
                // Get form data
                const name = document.getElementById('customer-name').value;
                const contactNumber = document.getElementById('contact-number').value;
                const bookingDate = document.getElementById('booking-date').value;
                const adultCount = document.getElementById('adult-count').value;
                const kidCount = document.getElementById('kid-count').value || '0';
                const toddlerCount = document.getElementById('toddler-count').value || '0';
                const courseCount = document.getElementById('course-count').value;

                // Validate required fields
                if (!name || !contactNumber || !bookingDate || !adultCount || !courseCount) {
                    throw new Error('Please fill in all required fields');
                }

                // Get selected items
                const selectedItemsHtml = document.getElementById('selected-items').innerHTML;
                const courseCountDisplay = document.getElementById('course-count-display').textContent;
                const menuPriceDisplay = document.getElementById('menu-price-display').textContent;

                // Format the selected items for WhatsApp
                const formattedItems = selectedItemsHtml
                    .replace(/<p>/g, '')
                    .replace(/<\/p>/g, '\n')
                    .replace(/<strong>/g, '')
                    .replace(/<\/strong>/g, '');

                // Create the message
                const message = `Hi, this is *${name}* regarding my menu selection for ${bookingDate}...\n\n` +
                    `*#Adults:* ${adultCount}\n` +
                    `*#Kids:* ${kidCount}\n` +
                    `*#Toddlers:* ${toddlerCount}\n` +
                    `*Selected Menu:* ${courseCount} course menu (${menuPriceDisplay})\n\n` +
                    `And here are my choices for the different courses:\n\n${formattedItems}`;

                // Encode the message for URL
                const encodedMessage = encodeURIComponent(message);

                // Replace with your WhatsApp number (include country code)
                const whatsappNumber = '85263982618'; // Replace with your actual WhatsApp number

                // Create WhatsApp URL
                const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;

                console.log("WhatsApp URL:", whatsappUrl);

                // Open WhatsApp in a new tab
                window.open(whatsappUrl, '_blank');
            } catch (error) {
                console.error('Error preparing WhatsApp message:', error);
                alert(error.message || 'Failed to prepare WhatsApp message. Please try again.');
            }
        }

        // Add click event listener to the WhatsApp button
        document.getElementById('send-whatsapp').addEventListener('click', sendWhatsApp);

        // Implicitly send email when whatsapp button is clicked
        document.getElementById('send-whatsapp').addEventListener('click', sendEmail);
    </script>
</body>
</html>